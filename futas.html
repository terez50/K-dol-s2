<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futás!</title>
</head>
<body>
    <canvas id="canvas" width="640" height="480"></canvas>
    <script>
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        function talaj(x, magassag) {
            this.x = x;
            this.szelesseg = 700;
            this.magassag = magassag;
        };
        var vilag = {
            magassag: 480,
            szelesseg: 640,
            gravitacio: 10,
            legmagasabbTalaj: 240,
            sebesseg: 5,
            megtettTav: 0,
            autoScroll: true,
            talajCsempe: [
                new talaj(0, 140)
            ],
            stop: function() {
                this.autoScroll = false;
            },
            talajMozgatas: function() {
                for(index in this.talajCsempe) {
                    var csempe = this.talajCsempe[index];
                    csempe.x -= this.sebesseg;
                    this.megtettTav += this.sebesseg;
                }
            },
            ujCsempeHozzaadas: function() {
                if(this.talajCsempe.length >= 3) {
                    return;
                };
                var elozoCsempe = this.talajCsempe[this.talajCsempe.length - 1];
                var legnagyobbUgrasMagassag = elozoCsempe.magassag + jatekos.magassag * 3.5;
                if(legnagyobbUgrasMagassag > this.legmagasabbTalaj) {
                    legnagyobbUgrasMagassag = this.legmagasabbTalaj;
                };
                var randomMagassag = Math.floor(Math.random() *  legnagyobbUgrasMagassag) + jatekos.magassag;
                balErtek = elozoCsempe.x + elozoCsempe.szelesseg;
                var kovetkezo = new talaj(balErtek, randomMagassag);
                this.talajCsempe.push(kovetkezo);
            },
            regiCsempekTorlese: function() {
                for (index in this.talajCsempe) {
                    if(this.talajCsempe[index].x <= -this.talajCsempe[index].szelesseg) {
                        this.talajCsempe.splice(index,1);
                    }
                }
            },
            talajTavMegadas: function(jatekosX) {
                for(index in this.talajCsempe) {
                    var csempe = this.talajCsempe[index];
                    if(csempe.x <= jatekosX && csempe.x + csempe.szelesseg >= jatekosX) {
                        return csempe.magassag;
                    }
                }
                return -1;
            },
            tick: function() {
                if(!this.autoScroll) {
                    return;
                };
                this.regiCsempekTorlese();
                this.ujCsempeHozzaadas();
                this.talajMozgatas();
            },
            megrajzolas: function() {
                ctx.fillStyle = "black";
                ctx.fillRect(0,0,this.szelesseg, this.magassag);
                for(index in this.talajCsempe) {
                    var csempe = this.talajCsempe[index];
                    var y = vilag.magassag - csempe.magassag;
                    ctx.fillStyle = "blue";
                    ctx.fillRect(csempe.x, y, csempe.szelesseg, csempe.magassag);
                }
            }
        };
        var jatekos = {
            x: 160,
            y: 340,
            magassag: 20,
            szelesseg: 20,
            lehuzoEro: vilag.gravitacio,
            ugrasMagassag: 0,
            tavMegadas: function(x) {
                var lentiPlatform = vilag.talajTavMegadas(x);
                return vilag.magassag - lentiPlatform - this.y;
            },
            gravitacioAlkalmazas: function() {
                // var lentiPlatform = vilag.talajTavMegadas(this.x);
                this.aktualisTalajTav = this.tavMegadas(this.x);
                // console.log("játékos: ", this.aktualisTalajTav);
                var jobbOldaliTav = this.tavMegadas(this.x + this.szelesseg);
                if(this.aktualisTalajTav < 0 || jobbOldaliTav < 0) {
                    vilag.stop();
                }
            },
            gravitácioFeldolgozas: function() {
                // this.y += vilag.gravitacio;
                this.y += this.lehuzoEro;
                var talajMagassag = vilag.talajTavMegadas(this.x, this.szelesseg);
                var talajYMagassaga = vilag.magassag - talajMagassag;
                if(this.y > talajYMagassaga) {
                    this.y = talajYMagassaga;
                }
                if(this.lehuzoEro < 0) {
                    this.ugrasMagassag += this.lehuzoEro * -1;
                    if(this.ugrasMagassag >= jatekos.magassag * 6) {
                        this.lehuzoEro = vilag.gravitacio;
                        this.ugrasMagassag = 0;
                    }
                }
            },
            billentyuLenyomas: function(keyInfo) {
                console.log("billentyűlenyomás");
                var talajMagassag = vilag.talajTavMegadas(this.x, this.szelesseg);
                var aPadlon = talajMagassag == (vilag.magassag - this.y);
                if(aPadlon) {
                    this.lehuzoEro = -8;
                }
            },
            tick: function() {
                this.gravitácioFeldolgozas();
                this.gravitacioAlkalmazas();
            },
            megrajzolas: function() {
                ctx.fillStyle = "green";
                ctx.fillRect(jatekos.x, jatekos.y - jatekos.magassag, this.szelesseg, this. magassag)
            }
        };
        window.addEventListener("keypress", function(keyInfo) 
            { jatekos.billentyuLenyomas(keyInfo); }, false
        );
        function tick() {
            jatekos.tick();
            vilag.tick();
            vilag.megrajzolas();
            jatekos.megrajzolas();
            window.setTimeout("tick()", 1000 / 60);
        };
        tick();
    </script>
</body>
</html>